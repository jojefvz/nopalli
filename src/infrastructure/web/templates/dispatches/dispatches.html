{% extends "base.html" %}

{% block main_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/modals.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/components.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/containers.css') }}">
{% endblock %}

{% block content %}
<div class="container" data-page="dispatches">
  <div class="container-header">
    <h2>Dispatches</h2>
    <button 
    type="button" 
    class="btn"
    @click="openNewDispatchModal">New Dispatch</button>
  </div>
  
  <!-- New Dispatch Modal (unchanged) -->
  <div v-if="newDispatchModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Dispatch</h2>
        <button 
        type="button" 
        class="close-btn"
        @click="newDispatchModal = false">×</button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('dispatch.create_dispatch') }}" method="post">
          <div class="form-field">
            <label for="broker_search">Broker</label>
            <div class="dropdown" style="margin: 0;">
              <input 
              type="text" 
              id="broker_search" 
              v-model="brokerSearch"
              @focus="showBrokerDropdown = true"
              @blur="hideBrokerDropdown"
              minlength="2"
              maxlength="100"
              autocomplete="off"
              required>
              <div v-if="showBrokerDropdown && filteredBrokers.length > 0" class="dropdown-list">
                <div 
                  v-for="broker in filteredBrokers" 
                  :key="broker.id"
                  @mousedown="selectBroker(broker)"
                  class="dropdown-option">
                  [[ broker.name ]]
                </div>
              </div>
            </div>
            <input type="hidden" name="broker_id" :value="selectedBrokerId">
          </div>
          <div class="form-field">
            <label for="driver_search">Driver</label>
            <div class="dropdown" style="margin: 0;">
              <input 
              type="text" 
              id="driver_search" 
              v-model="driverSearch"
              @focus="showDriverDropdown = true"
              @blur="hideDriverDropdown"
              minlength="2"
              maxlength="100"
              autocomplete="off"
              required>
              <div v-if="showDriverDropdown && filteredDrivers.length > 0" class="dropdown-list">
                <div 
                  v-for="driver in filteredDrivers" 
                  :key="driver.id"
                  @mousedown="selectDriver(driver)"
                  class="dropdown-option">
                  [[ driver.name ]]
                </div>
              </div>
            </div>
            <input type="hidden" name="driver_id" :value="selectedDriverId">
          </div>
          <div class="form-field" style="flex-direction: column;">
            <label>Container Numbers</label>
            <div v-for="(container, index) in containerNumbers" :key="index" class="input-group">
              <input 
                type="text" 
                v-model="containerNumbers[index]"
                :name="'container_' + index"
                placeholder="Enter container number"
                required>
              <button 
                v-if="containerNumbers.length > 1"
                type="button" 
                @click="removeContainer(index)"
                class="btn-remove">×</button>
            </div>
            <button 
              type="button" 
              @click="addContainer"
              class="btn-add">+ Add Container</button>
          </div>
          <div class="stops-section">
            <h3>Stops</h3>
            <div v-for="(stop, stopIndex) in stops" :key="stopIndex" class="stop-container">
              <div class="stop-header">
                <h4>Stop [[ stopIndex + 1 ]]</h4>
                <button 
                  v-if="stops.length > 2"
                  type="button" 
                  @click="removeStop(stopIndex)"
                  class="btn-remove">Remove Stop</button>
              </div>

              <div class="form-field">
                <label :for="'location_search_' + stopIndex">Location</label>
                <div class="dropdown" style="margin: 0;">
                  <input 
                    type="text" 
                    :id="'location_search_' + stopIndex"
                    v-model="stop.locationSearch"
                    @focus="stop.showLocationDropdown = true"
                    @blur="hideLocationDropdown(stopIndex)"
                    minlength="2"
                    maxlength="100"
                    autocomplete="off"
                    required>
                  <div v-if="stop.showLocationDropdown && getFilteredLocations(stopIndex).length > 0" class="dropdown-list">
                    <div 
                      v-for="location in getFilteredLocations(stopIndex)" 
                      :key="location.id"
                      @mousedown="selectLocation(stopIndex, location)"
                      class="dropdown-option">
                      [[ location.name ]]
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-field">
                <label>Instruction</label>
                <select :name="'instruction_' + stopIndex" v-model="stop.instruction">
                  <option value="">Select an instruction</option>
                  <option value="fetch_chassis">Fetch Chassis</option>
                  <option value="prepull">Prepull</option>
                  <option value="bobtail_to">Bobtail To</option>
                  <option value="pickup_empty">Pickup Empty</option>
                  <option value="drop_empty">Drop Empty</option>
                  <option value="live_load">Live Load</option>
                  <option value="pickup_loaded">Pickup Loaded</option>
                  <option value="drop_loaded">Drop Loaded</option>
                  <option value="live_unload">Live Unload</option>
                  <option value="terminate_empty">Terminate Empty</option>
                  <option value="terminate_chassis">Terminate Chassis</option>
                  <option value="ingate">Ingate</option>
                  <option value="yard_pull">Yard Pull</option>
                  <option value="street_turn">Street Turn</option>
                </select>
              </div>

              <div class="form-field">
                <label>Select Container</label>
                <select :name="'selected_container_' + stopIndex" v-model="stop.selectedContainer">
                  <option value="">Select a container</option>
                  <option 
                    v-for="(container, index) in filledContainers" 
                    :key="index" 
                    :value="container">
                    [[ container ]]
                  </option>
                </select>
              </div>

              <div class="form-field">
                <label>Date</label>
                <input type="date" :name="'date_' + stopIndex" v-model="stop.date">
              </div>

              <div class="form-field">
                <label>Appointment Type</label>
                <select :name="'appointment_type_' + stopIndex" v-model="stop.appointmentType">
                  <option value="">Select appointment type</option>
                  <option value="open">Open Appointment</option>
                  <option value="exact_time">Exact Time</option>
                  <option value="time_window">Time Window</option>
                  <option value="ready_after">Ready After</option>
                  <option value="finish_by">Finish By</option>
                </select>
              </div>

              <div class="form-field" v-if="showStartTime(stopIndex)">
                <label>Start Time</label>
                <input type="time" :name="'start_time_' + stopIndex" v-model="stop.startTime">
              </div>

              <div class="form-field" v-if="showEndTime(stopIndex)">
                <label>End Time</label>
                <input type="time" :name="'end_time_' + stopIndex" v-model="stop.endTime">
              </div>
            </div>

            <button 
              type="button" 
              @click="addStop"
              class="btn-add">+ Add Stop</button>
          </div>          
          <div class="form-field">
            <button type="submit">Submit</button>
          </div>
        </form>
      </div>
      <div class="modal-footer"></div>
    </div>
  </div>
  
  <!-- Dispatch List -->
  <div class="container-content">
    <div v-for="dispatch in dispatches" :key="dispatch.reference" class="object-container">
      <div class="object-details">
        <h3>[[ dispatch.reference ]] ([[ dispatch.status ]])</h3>
        <button @click="openEditModal(dispatch)">Edit</button>
      </div>
      {#<button type="button" @click="openActivateModal(dispatch)">
        [[ dispatch.status === 'Draft' ? 'Deactivate' : 'Activate' ]]
      </button>#}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script> 
  createApp({
    delimiters: ['[[', ']]'],
    data() {
      return {
        newDispatchModal: false,
        selectedDispatch: null,  // Stores the currently selected dispatch
        dispatches: [
          {% for dispatch in dispatches %}
            {
              id: "{{ dispatch.id }}",
              reference: "{{ dispatch.reference }}",
              status: "{{ dispatch.status }}",
              broker_name: "{{ dispatch.broker_name }}",
              driver_name: {{ dispatch.driver_name|tojson }},
              container_numbers: {{ dispatch.container_numbers|tojson }},
              plan: {{ dispatch.plan|tojson }}
            }{{ "," if not loop.last }}
          {% endfor %}
        ],
        
        // brokers
        brokerSearch: '',
        selectedBrokerId: '',
        showBrokerDropdown: false,
        brokers: [],
        loadingBrokers: false,
          
        // drivers
        driverSearch: '',
        selectedDriverId: '',
        showDriverDropdown: false,
        drivers: [],
        loadingDrivers: false,

        // containers
        containerNumbers: [''],

        locations: [],
        loadingLocations: false,

        // stops
        stops: [
          this.createEmptyStop(),
          this.createEmptyStop()
        ]
      }
    },
    computed: {
      filteredBrokers() {
        if (!this.brokerSearch) return this.brokers;

        const search = this.brokerSearch.toLowerCase();
        return this.brokers.filter(broker => 
          broker.name.toLowerCase().includes(search)
        )
      },
      filteredDrivers() {
        if (!this.driverSearch) return this.drivers;

        const search = this.driverSearch.toLowerCase();
        return this.drivers.filter(driver => 
          driver.name.toLowerCase().includes(search)
        )
      },
      filledContainers() {
        return this.containerNumbers.filter(container => container.trim() !== '');
      }
    },
    methods: {
      async fetchBrokers() {
        this.loadingBrokers = true;
        try {
          const response = await fetch('{{ url_for("broker.get_active_brokers") }}');
          const data = await response.json();
          this.brokers = data;
        } catch (error) {
          console.error('Error fetching brokers:', error);
        } finally {
          this.loadingBrokers = false;
        }
      },
      selectBroker(broker) {
        this.brokerSearch = broker.name;
        this.selectedBrokerId = broker.id;
        this.showBrokerDropdown = false;
      },
      hideBrokerDropdown() {
        setTimeout(() => {
          this.showBrokerDropdown = false;
        }, 200);
      },
      async fetchDrivers() {
        this.loadingDrivers = true;
        try {
          const response = await fetch('{{ url_for("driver.get_available_and_operating") }}');
          const data = await response.json();
          this.drivers = data;
        } catch (error) {
          console.error('Error fetching drivers:', error);
        } finally {
          this.loadingDrivers = false;
        }
      },
      selectDriver(driver) {
        this.driverSearch = driver.name;
        this.selectedDriverId = driver.id;
        this.showDriverDropdown = false;
      },
      hideDriverDropdown() {
        setTimeout(() => {
          this.showDriverDropdown = false;
        }, 200);
      },
      openNewDispatchModal() {
        this.newDispatchModal = true;
        this.fetchBrokers();
        this.fetchDrivers();
      },
      addContainer() {
        this.containerNumbers.push('');
      },
      removeContainer(index) {
        this.containerNumbers.splice(index, 1);
      },
      createEmptyStop() {
        return {
          locationSearch: '',
          selectedLocationId: '',
          showLocationDropdown: false,
          instruction: '',
          selectedContainer: '',
          date: '',
          appointmentType: '',
          startTime: '',
          endTime: ''
        };
      },
      async fetchLocations() {
        this.loadingLocations = true;
        try {
          const response = await fetch('{{ url_for("location.get_active_locations") }}');
          const data = await response.json();
          this.locations = data;
        } catch (error) {
          console.error('Error fetching locations:', error);
        } finally {
          this.loadingLocations = false;
        }
      },
      getFilteredLocations(stopIndex) {
        const stop = this.stops[stopIndex];
        if (!stop.locationSearch) return this.locations;
        
        const search = stop.locationSearch.toLowerCase();
        return this.locations.filter(location => 
          location.name.toLowerCase().includes(search)
        );
      },
      selectLocation(location) {
        this.locationSearch = location.name;
        this.selectedLocationId = location.id;
        this.showLocationDropdown = false;
      },
      hideLocationDropdown() {
        setTimeout(() => {
          this.showLocationDropdown = false;
        }, 200);
      },
      addStop() {
        this.stops.push(this.createEmptyStop());
      },
      removeStop(index) {
        if (this.stops.length > 2) {
          this.stops.splice(index, 1);
        }
      },
      showStartTime(stopIndex) {
        const appointmentType = this.stops[stopIndex].appointmentType;
        return ['exact_time', 'time_window', 'ready_after', 'finish_by'].includes(appointmentType);
      },
      showEndTime(stopIndex) {
        return this.stops[stopIndex].appointmentType === 'time_window';
      },
      openNewDispatchModal() {
        this.newDispatchModal = true;
        this.fetchBrokers();
        this.fetchDrivers();
        this.fetchLocations();
      },
    }
  }).mount('[data-page="dispatches"]');
</script>
{% endblock %}